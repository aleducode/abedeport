log:
  level: INFO

entryPoints:
  web:
    address: ':80'
    http:
      redirections:
        entrypoint:
          to: websecure
          scheme: https
          permanent: true
  websecure:
    address: ':443'

certificatesResolvers:
  letsencrypt:
    acme:
      email: admin@abedeport.abejorralmuchopueblo.com
      storage: /etc/traefik/acme/acme.json
      httpChallenge:
        entryPoint: web

http:
  routers:

    # Static assets with long cache (JS, CSS, fonts, images)
    static-assets-router:
      rule: "Host(`abedeport.abejorralmuchopueblo.com`) && PathPrefix(`/assets/`)"
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - cache-headers
      service: abedeport-app
      tls:
        certResolver: letsencrypt
      priority: 100

    # Main application router (lower priority)
    web-router:
      rule: "Host(`abedeport.abejorralmuchopueblo.com`)"
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - cache-short
      service: abedeport-app
      tls:
        certResolver: letsencrypt
      priority: 50

    # phpMyAdmin router
    phpmyadmin-router:
      rule: "Host(`pma.abedeport.abejorralmuchopueblo.com`)"
      entryPoints:
        - websecure
      middlewares:
        - security-headers
      service: phpmyadmin
      tls:
        certResolver: letsencrypt

  middlewares:
    security-headers:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"
        hostsProxyHeaders:
          - "X-Forwarded-Host"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Robots-Tag: "index,follow"
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
    
    cache-headers:
      headers:
        customResponseHeaders:
          Cache-Control: "public, max-age=31536000, immutable"
          
    cache-short:
      headers:
        customResponseHeaders:
          Cache-Control: "public, max-age=86400"

  services:
    abedeport-app:
      loadBalancer:
        servers:
          - url: http://app:80

    phpmyadmin:
      loadBalancer:
        servers:
          - url: http://phpmyadmin:80

providers:
  file:
    filename: /etc/traefik/traefik.yml
    watch: true